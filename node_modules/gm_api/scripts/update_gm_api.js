// 此脚本是上层项目的脚本，因此尽量不搞太多依赖
const path = require('path')
const fs = require('fs-extra')
const sh = require('shelljs')

const appDirectory = fs.realpathSync(process.cwd())
function getGitBranch() {
  const branch = sh
    .exec('git rev-parse --abbrev-ref HEAD', {
      silent: true,
    })
    .stdout.slice(0, -1)

  return branch
}

function getGMApiCommitId(branch) {
  const hash = sh
    .exec(
      `git ls-remote --heads git@code.guanmai.cn:fe-x/gm_api.git ${branch}`,
      { silent: true },
    )
    .stdout.slice(0, -1)

  return hash.replace(`refs/heads/${branch}`, '').trim()
}

const branch = getGitBranch()
const packageJson = require(path.resolve(appDirectory, './package.json'))
// 如果是 develop，对于 gm_api 是 master
const newGmApiCommitId = getGMApiCommitId(
  branch === 'develop' ? 'master' : branch,
)
// 当前packageJson里面gm_api的commitId
const currentGmApiCommitId = packageJson.dependencies.gm_api.split('#')[1]

if (newGmApiCommitId === currentGmApiCommitId) {
  console.log(
    `当前 gm_api。branch ${branch} commitId ${newGmApiCommitId} 已经是最新节点无需更新`,
  )
} else {
  // 更新 gm_api
  packageJson.dependencies.gm_api = `git+https://code.guanmai.cn/fe-x/gm_api.git#${newGmApiCommitId}`

  fs.writeFileSync(
    path.resolve(appDirectory, './package.json'),
    JSON.stringify(packageJson, null, 2) + '\n',
  )
  console.log(
    `自动更新依赖 gm_api。branch ${branch} commitId ${newGmApiCommitId}`,
  )
}
