
syntax = "proto3";

package ceres.databi;
option  java_multiple_files = true;
option  go_package          = "code.guanmai.cn/back_end/ceres/databi/proto;proto";

import "./google/api/annotations.proto";

import "./analytics/proto/analytics.proto";
import "./merchandise/proto/merchandise.proto";

service DataBIService {
    // 汇总summary，一个时间区间一组汇总数据，时间区间之间比较数值变化；按group by聚合数据，不支持排序
    // 趋势trend  ，一个时间区间一组趋势数据，时间区间之间比较变化曲线；按时间维度聚合数据，排序字段可选
    // 排行rank   ，一个时间区间一组排行数据，时间区间之间比较名称升降；按榜单类型聚合数据，排序字段可选

    rpc Query(QueryRequest) returns (QueryResponse) {
        option (google.api.http) = {
            post : "/ceres/databi/DataBIService/Query"
        };
    }

    // 生产计划报表
    rpc GetProductionProduceTaskData(GetProductionProduceTaskDataRequest) returns (GetProductionProduceTaskDataResponse) {
        option (google.api.http) = {
            post : "/ceres/databi/DataBIService/GetProductionProduceTaskData"
        };
    }

    // 包装计划报表
    rpc GetProductionPackTaskData(GetProductionPackTaskDataRequest) returns (GetProductionPackTaskDataResponse) {
        option (google.api.http) = {
            post : "/ceres/databi/DataBIService/GetProductionPackTaskData"
        };
    }
}

// 时间区间，左闭右闭[begin_time, end_time]
message TimeRange {
    uint64 begin_time = 1; // 开始时间
    uint64 end_time   = 2; // 结束时间
    string time_field = 3; // 时间字段，TimeRange > PresetExpr > 默认create_time
}

// 预设查询参数，FieldNumber为"{{Service.Port}}XXXX"，每个模块10000个
enum PresetType {
    PRESET_TYPE_UNSPECIFIED = 0;

    PRESET_TYPE_ANALYTICS_EXAMPLE_SUMMARY = 20030001; // 测试摘要
    PRESET_TYPE_ANALYTICS_EXAMPLE_TREND   = 20031001; // 测试趋势
    PRESET_TYPE_ANALYTICS_EXAMPLE_RANK    = 20032001; // 测试排行

    // order
    PRESET_TYPE_ORDER_ORDER_SUMMARY                       = 20480001; // 订单摘要
    PRESET_TYPE_ORDER_ORDER_TREND                         = 20481001; // 订单趋势
    PRESET_TYPE_ORDER_ORDER_RANK_CUSTOMER_ORDER_PRICE_SUM = 20482001; // 订单排行-客户下单金额
    PRESET_TYPE_ORDER_ORDER_RANK_CUSTOMER_ORDER_ID_COUNT  = 20482002; // 订单排行-客户下单数

    // order-eshop
    PRESET_TYPE_ORDER_ORDER_ESHOP_RANK           = 20483001; // 团餐订单排行
    PRESET_TYPE_ORDER_ORDER_ESHOP_CUSTOMER_TREND = 20483002; // 团餐客户交易趋势

    // production
    PRESET_TYPE_PRODUCTION_TASK_PRODUCE_SUMMARY = 85700001; // 生产任务报表-产品
    PRESET_TYPE_PRODUCTION_TASK_PRODUCE_RANK    = 85700002; // 生产任务排行-实际用料金额
    PRESET_TYPE_PRODUCTION_TASK_PACK_RANK       = 85700003; // 包装任务排行-实际用料金额

    PRESET_TYPE_PRODUCTION_TASKINPUT_SUMMARY = 85701001; // 生产任务报表-原料

    PRESET_TYPE_PRODUCTION_TASKOUTPUT_SUMMARY = 85702001; // 生产任务报表-产出

    // 售后  after sale
    PRESET_TYPE_AFTER_SALE_CREATE_AMOUNT_TREND           = 55505001; // 售后金额趋势 - 建单时间
    PRESET_TYPE_AFTER_SALE_PLACE_AMOUNT_TREND            = 55505002; // 售后金额趋势 - 下单时间
    PRESET_TYPE_AFTER_SALE_RECEIVE_AMOUNT_TREND          = 55505003; // 售后金额趋势 - 收货时间
    PRESET_TYPE_AFTER_SALE_CREATE_ORDER_NUM_TREND        = 55505004; // 售后单数量趋势 - 建单时间
    PRESET_TYPE_AFTER_SALE_PLACE_ORDER_NUM_TREND         = 55505005; // 售后单数量趋势 - 下单时间
    PRESET_TYPE_AFTER_SALE_RECIEVE_ORDER_NUM_TREND_TREND = 55505006; // 售后单数量趋势 - 收货时间
    PRESET_TYPE_AFTER_SALE__CREATE_AMOUNT_RANK           = 55505007; // 售后金额商户排行 - 建单时间
    PRESET_TYPE_AFTER_SALE_PLACE_AMOUNT_RANK             = 55505008; // 售后金额商户排行 - 下单时间
    PRESET_TYPE_AFTER_SALE_RECIEVE_AMOUNT_RANK           = 55505009; // 售后金额商户排行 - 收货时间
}

message QueryRequest {
    repeated TimeRange time_ranges = 1;

    PresetType          preset_type = 10; // 预设类型，使用预设查询条件
    analytics.QueryExpr expr        = 11; // 高级模式，使用自定义查询条件；如果同时指定preset_type和expr，那么expr中除ModelType的字会覆盖preset配置
}

message QueryResponse {
    repeated analytics.QueryData data = 1;
}

message GetProductionProduceTaskDataRequest {
    TimeRange                     time_range           = 1;
    merchandise.GetManySkuRequest get_many_sku_request = 2;

    analytics.QueryExpr task_expr   = 10;
    analytics.QueryExpr input_expr  = 11;
    analytics.QueryExpr output_expr = 12;
}

message GetProductionProduceTaskDataResponse {
    analytics.QueryData task_data   = 1;
    analytics.QueryData input_data  = 2;
    analytics.QueryData output_data = 3;
}

message GetProductionPackTaskDataRequest {
    TimeRange                     time_range           = 1;
    merchandise.GetManySkuRequest get_many_sku_request = 2;

    analytics.QueryExpr task_expr   = 10;
    analytics.QueryExpr input_expr  = 11;
    analytics.QueryExpr output_expr = 12;
}

message GetProductionPackTaskDataResponse {
    analytics.QueryData task_data   = 1;
    analytics.QueryData input_data  = 2;
    analytics.QueryData output_data = 3;
}
